/*! ngImageEditor 0.0.2 | Copyright (c) 2014 sparrow.jang | MIT license */
!function(a){"use strict";var b=a.module("ngImageEditor",[]),c=function(a){this.canvas_=a,this.ctx_=a.getContext("2d")};a.extend(c.prototype,{refresh:function(){var a=this.canvas_,b=a.parentNode;a.width=b.clientWidth,a.height=b.clientHeight},converterToGray_:function(){for(var a=this.ctx_,b=this.canvas_,c=a.getImageData(0,0,b.width,b.height),d=c.data,e=d.length,f=0;e>f;f+=4){var g=(d[f],d[f+1],d[f+2],.34*d[f]+.5*d[f+1]+.16*d[f+2]);d[f]=g,d[f+1]=g,d[f+2]=g}a.putImageData(c,0,0)},drawImageBlock:function(a,b,c,d,e,f,g,h,i){var j=h/a.width,k=i/a.height,l=d/a.width*f,m=e/a.height*g,n=f*j,o=g*k;b.drawImage(c,l,m,n,o,d,e,h,i)},render:function(a,b,c){{var d=this.ctx_,e=this.canvas_,f=e.width,g=e.height;c.width/f,c.height/g}d.drawImage(a,0,0,f,g),this.converterToGray_(),this.drawImageBlock(e,d,a,b.left,b.top,c.width,c.height,b.width,b.height)},refreshAndRender:function(a,b,c){this.refresh(),this.render(a,b,c)},toDataURL:function(a,b){var c=this.canvas_,d=document.createElement("canvas"),e=d.getContext("2d");return d.width=b.width,d.height=b.height,e.drawImage(c,b.left,b.top,b.width,b.height,0,0,b.width,b.height),d.toDataURL(a)}}),b.directive("ngImageEditor",["$q",function(b){var d=function(c){var d=new Image,e=document.createElement("div"),f=b.defer(),g=a.element(document.body);return d.crossOrigin="Anonymous",e.style.cssText="width:0px;height:0px;overflow:hidden;",d.onload=function(){var a,b;a=d.width,b=d.height,e.parentNode.removeChild(e),f.resolve({width:a,height:b})},e.appendChild(d),d.src=a.isString(c)?c:c.src,g.append(e),f.promise};return{scope:{imgSrc:"=",ngImageEditor:"=",onImgChange:"&",selected:"="},template:'<div ng-mousemove="move( $event )" ng-mouseup="cancel( $event )" unselectable="on"><img unselectable="on" style="opacity:0;user-drag: none;width:100%;height:100%;" crossorigin="Anonymous" ng-src="{{imgSrc}}" ng-mousedown="$event.preventDefault()" /><canvas width="100%" height="100%" style="position:absolute;top:0px;left:0px;"></canvas><div ng-image-selected></div></div>',controller:["$scope","$element","$attrs",function(b,e){var f,g,h,i,j,k;e.css({position:"relative","user-drag":"none"}).attr("unselectable","on"),g=e.find("canvas"),f=g[0],h=new c(f),i=e.find("img")[0],k=a.element(document.body);var l={imgSrc:function(a){var c=d(a);c.then(function(a){j=a,h.refreshAndRender(i,b.selected,j),b.onImgChange()})},selected:function(a){null==b.dragEvent&&j&&h.refreshAndRender(i,a,j)}};b.$watch("imgSrc",l.imgSrc),b.$watchCollection("selected",l.selected),a.extend(b,{move:function(a){var c,d,f=b.dragEvent,g=b.selected,k=e[0].clientHeight-g.height,l=e[0].clientWidth-g.width;f&&(c=g.top-(f.clientY-a.clientY),d=g.left-(f.clientX-a.clientX),g.top=0>c?0:c>k?k:c,g.left=0>d?0:d>l?l:d,h.refreshAndRender(i,b.selected,j),b.dragEvent=a)},cancel:function(){b.dragEvent=null},ngImageEditor:{toDataURL:function(a){var c=a?a:"image/png";return h.toDataURL(c,b.selected)},refresh:function(){h.refreshAndRender(i,b.selected,j)}}}),k.on("mouseup",function(){b.cancel()})}]}}]),b.directive("ngImageSelected",function(){return{require:"^ngImageEditor",selected:"=",template:"<div style=\"box-sizing:border-box;background:rgba(255, 255, 255, 0.1);border:2px dashed #eaeaea;cursor:all-scroll;position:absolute;\" ng-style=\"{width:selected.width + 'px' , height:selected.height + 'px',left:selected.left + 'px',top:selected.top + 'px'}\" ng-mousedown=\"dragEvent=$event;$event.preventDefault()\"></div>",replace:!0,link:function(){}}})}(angular);